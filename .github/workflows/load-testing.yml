name: Load Testing

on:
  pull_request:
    paths:
      - 'src/handlers/**'
      - 'src/services/**'
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration in seconds'
        required: false
        default: '60'
      rate:
        description: 'Requests per second'
        required: false
        default: '100'

env:
  CARGO_TERM_COLOR: always

jobs:
  load-test:
    name: Performance Load Test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: stateset
          POSTGRES_PASSWORD: stateset
          POSTGRES_DB: stateset_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build release binary
        run: cargo build --release

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Start API server
        env:
          DATABASE_URL: postgres://stateset:stateset@localhost:5432/stateset_test
          REDIS_URL: redis://localhost:6379
          APP__DATABASE_URL: postgres://stateset:stateset@localhost:5432/stateset_test
          APP__REDIS_URL: redis://localhost:6379
          APP__JWT_SECRET: ci_jwt_secret_for_tests_only_please_change_me_to_secure_value_2025!
          APP__SERVER__PORT: 8080
        run: |
          ./target/release/stateset-api &
          sleep 10  # Wait for server to start

      - name: Run load tests
        run: |
          k6 run --out json=results.json tests/load/k6-script.js

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: results.json

      - name: Check performance thresholds
        run: |
          # Parse results and fail if thresholds exceeded
          python3 -c "
          import json
          with open('results.json') as f:
              for line in f:
                  data = json.loads(line)
                  if data.get('type') == 'Point' and data.get('metric') == 'http_req_duration':
                      if data['data']['value'] > 500:
                          print(f'WARNING: Request took {data[\"data\"][\"value\"]}ms')
          "
